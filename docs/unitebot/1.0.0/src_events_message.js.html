<!-- start:source.tmpl.hbs -->
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
		<title>src/events/message.js</title>
		<!--[if lt IE 9]>
		<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
		<link href="https://fonts.googleapis.com/css?family=PT+Mono" rel="stylesheet">
		<link type="text/css" rel="stylesheet" href="css/bootstrap.min.css">
		<link type="text/css" rel="stylesheet" href="css/prism.min.css">
		<link type="text/css" rel="stylesheet" href="css/template.min.css">
		<script type="text/javascript">
			window.TEMPLATE_OPTIONS = {"includeDate":"true","dateFormat":"dddd, MMMM Do YYYY, h:mm:ss a","systemName":"UNITEBOT","systemSummary":"「CODΞ」DΞVS","systemLogo":"","systemColor":"","navMembers":[{"kind":"class","title":"Classes","summary":"All documented classes."},{"kind":"external","title":"Externals","summary":"All documented external members."},{"kind":"global","title":"Globals","summary":"All documented globals."},{"kind":"mixin","title":"Mixins","summary":"All documented mixins."},{"kind":"interface","title":"Interfaces","summary":"All documented interfaces."},{"kind":"module","title":"Modules","summary":"All documented modules."},{"kind":"namespace","title":"Namespaces","summary":"All documented namespaces."},{"kind":"tutorial","title":"Tutorials","summary":"All available tutorials."}],"footer":"Redmine <a href='https://unitebot.fun'>https://unitebot.fun</a>","copyright":"Copyright by「CODΞ」DΞVS 2020","linenums":true,"collapseSymbols":true,"inverseNav":true,"inlineNav":false,"outputSourceFiles":true,"sourceRootPath":null,"disablePackagePath":true,"outputSourcePath":true,"showTableOfContents":true,"showAccessFilter":true,"analytics":"","methodHeadingReturns":true,"sort":"since","search":true,"favicon":"","stylesheets":[],"scripts":[],"monospaceLinks":false,"cleverLinks":false,"useLongnameInNav":true,"showInheritedInNav":true};
			window.DOCLET_TOC_ENABLED = false;
			window.DOCLET_AFILTER_ENABLED = false;
		</script>
</head>
<body>
	<!-- start:navbar.hbs -->
	<header class="navbar navbar-default navbar-fixed-top navbar-inverse">
		<div class="container">
			<div class="navbar-header">
				<a class="navbar-brand" href="index.html">
					UNITEBOT
				</a>
				<!-- displayed on small devices -->
				<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
			</div>
			<div class="navbar-collapse collapse" id="topNavigation">
				<ul class="nav navbar-nav">
								<li class="dropdown">
									<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Globals<b class="caret"></b></a>
									<ul class="dropdown-menu">
											<li><a href="global.html#devs">devs</a></li>
											<li><a href="global.html#premissions">premissions</a></li>
											<li><a href="global.html#trans">trans</a></li>
											<li><a href="global.html#uFunctions">uFunctions</a></li>
									</ul>
								</li>
								<li class="dropdown">
									<a href="list_class.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
									<ul class="dropdown-menu">
											<li><a href="ActionMessages.html">ActionMessages</a></li>
											<li><a href="Deus.html">Deus</a></li>
											<li><a href="Discord.Channel.html">Discord.Channel</a></li>
											<li><a href="Discord.Client.html">Discord.Client</a></li>
											<li><a href="Discord.Collection.html">Discord.Collection</a></li>
											<li><a href="Discord.Guild.html">Discord.Guild</a></li>
											<li><a href="Discord.Message.html">Discord.Message</a></li>
											<li><a href="Discord.User.html">Discord.User</a></li>
											<li><a href="UBot.html">UBot</a></li>
											<li><a href="UBot.manager.ChannelManager.html">UBot.manager.ChannelManager</a></li>
											<li><a href="UBot.manager.GameManager.html">UBot.manager.GameManager</a></li>
											<li><a href="UBot.manager.GuildsManager.html">UBot.manager.GuildsManager</a></li>
											<li><a href="UBot.manager.PrivateManager.html">UBot.manager.PrivateManager</a></li>
											<li><a href="UBot.manager.UserManager.html">UBot.manager.UserManager</a></li>
									</ul>
								</li>
								<li class="dropdown">
									<a href="list_external.html" class="dropdown-toggle" data-toggle="dropdown">Externals<b class="caret"></b></a>
									<ul class="dropdown-menu">
											<li><a href="external-Config.html">Config</a></li>
											<li><a href="external-moment.html">moment</a></li>
											<li><a href="external-Mongoose.html">Mongoose</a></li>
											<li><a href="external-Spinnies.html">Spinnies</a></li>
											<li><a href="external-Table.html">Table</a></li>
											<li><a href="external-Translator.html">Translator</a></li>
									</ul>
								</li>
								<li class="dropdown">
									<a href="list_module.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b class="caret"></b></a>
									<ul class="dropdown-menu">
											<li><a href="commands.module_channel.html">commands.channel</a></li>
											<li><a href="commands.module_setup.html">commands.setup</a></li>
									</ul>
								</li>
								<li class="dropdown">
									<a href="list_namespace.html" class="dropdown-toggle" data-toggle="dropdown">Namespaces<b class="caret"></b></a>
									<ul class="dropdown-menu">
											<li><a href="Discord.html">Discord</a></li>
									</ul>
								</li>
								<li class="dropdown">
									<a href="list_tutorial.html" class="dropdown-toggle" data-toggle="dropdown">Tutorials<b class="caret"></b></a>
									<ul class="dropdown-menu">
											<li><a href="tutorial-commands.html">Команды</a></li>
											<li><a href="tutorial-manager.html">Управление ботом</a></li>
											<li><a href="tutorial-starting.html">Настройки и установка</a></li>
									</ul>
								</li>
				</ul>
					<!-- start:lunr-search-navbar.hbs -->
					<form class="navbar-form navbar-right" role="search">
						<div class="input-group">
							<input type="text" class="form-control" placeholder="Search" id="lunr-search-input">
							<div class="input-group-btn">
								<button class="btn btn-default" id="lunr-search-submit">
									<i class="glyphicon glyphicon-search"></i>
								</button>
							</div>
						</div>
					</form>
					<!-- start:lunr-search-navbar.hbs -->		</div>
		</div>
	</header>
	<!-- end:navbar.hbs -->		<div class="page-header">
			<div class="container">
				<span class="kind">source</span>
				<h1><span class="name">src/events/message.js</span></h1>
			</div>
		</div>
	<div class="container content">
		<div class="row">
			<div class="col-md-12 main-content">
		<section class="source-section">
			<article></article>
			<pre class="prettyprint source language-javascript line-numbers"><code class="language-javascript">const {Collection} = require('discord.js')
const cooldowns = new Collection();

/**
 * Обработчик события&lt;br/>
 * Принимает все сообщения от бота
 * @event UBot.message
 * @param unite {UBot} бот объект с огромным функционалом
 * @param message {Message} сообщение объект {@link unite.message}
 * @return {Promise&lt;{T}>}
 * @type {EventListener}
 */
module.exports = async (unite, message) => {


    //devs.showObject(unite,1)

    this.unite = unite

    const {channels, models, manager, users, commands} = unite
    const {guildSchema} = models
    const {ActionMessages, GuildsManager} = manager

    const {guild, author, channel} = message
    const localGuild = new GuildsManager(unite, guild, message) // Берем данные дильдии из базы


    // Определяем префиксы и приватный канал
    let botPrefix, privateCID, pcID, prefix
    let guildReady = false
    if (message.guild !== null) {
        guildReady = await localGuild.isReadyGuild // проверяем наличие гильдии в базе
        botPrefix = await guildSchema.getPrefix(guild.id)
        privateCID = await guildSchema.getPrivateChannelID(guild.id)
    }
    // Назаначаем префикс
    botPrefix ? prefix = botPrefix.prefix : prefix = config.bot.prefix
    privateCID ? pcID = privateCID.privateChannelID : pcID = config.privateChannelID;

    /** проверяем есть ли гильдия в Mongo */
    if (guildReady) {
        // Save all messages
        const saveMSG = new ActionMessages(unite);
        await saveMSG.saveMessage(message);
    }

    /** Если канал DM (приватный) то отправляем сообщение пользователю */
    channel.type === 'dm' ? channels.cache.find(dmChannel => {
        if (dmChannel.name === author.discriminator) {
            dmChannel.send(message.content)
        }
    }) : null



    /** Игнорируем сообщения от бота */
    if (author.bot) return;

    

    /**
     * Находим пользователя с дискриминатором
     * UserName # 3223
     *    ┬     ┬  ┬
     *    |     |  |
     *    |     |  └─-----  discriminator
     *    |     └─--------  tag
     *    └─--------------  Nickname or Username
     * Далее сравниваем есть ли у канала {ParentID} === {pcID} индетификатор каталога PRIVATE
     * Если есть то отправляем сообщение приватное DM для пользователя
     *
     */

    users.cache.find(user => {
        if (user.discriminator === message.channel.name) {
            if (channel.parentID === pcID) {
                user.send(message.content)
            } else {
                message.reply('ОМГ! Что то пошло не так')
            }
        }
    })

    /** Проверяем сообщение от гильдии ? если да идем джальше : закрываем */
    if (!guild) return; // exit if not guild


    const prefixMention = new RegExp(`^&lt;@!?${unite.user.id}> `);
    const newPrefix = message.content.match(prefixMention) ? message.content.match(prefixMention)[0] : prefix;

    const getPrefix = new RegExp(`^&lt;@!?${unite.user.id}>( |)$`);
    if (message.content.match(getPrefix)) return message.channel.send(`My prefix in this guild is \`${prefix}\``);
    if (message.content.indexOf(newPrefix) !== 0) return;


    // Проверяем отправляется ли сообщение от бота или сообщение без префикса - игнор
    if (!message.content.startsWith(prefix) || message.author.bot) return;

    // Принимает аргументы (делим сообщение)
    // Все команды переводим в нижний регистр
    const args = message.content.slice(newPrefix.length).trim().split(/ +/g);
    const commandName = args.shift().toLowerCase();
    //unite.emit(commandName,args)
    // Проверяем есть ли альтернативные команды для бота
    // Пример: вместо команды !avatar можно набрать !icon
    const command = commands.get(commandName)
        || commands.find(cmd => cmd.aliases &amp;&amp; cmd.aliases.includes(commandName));
    // Отсутвие команд отбой
    if (!command) return;

    if (command.guildOnly &amp;&amp; message.channel.type !== 'text') {
        return message.reply('I can\'t execute that command inside DMs!');
    } else {

    }

    if (command.args &amp;&amp; !args.length) {
        let reply = `You didn't provide any arguments, ${author}!`;
        if (command.usage) {
            reply += `\nThe proper usage would be: \`${prefix}${command.name} ${command.usage}\``;
        }
        return channel.send(reply);
    }

    if (!cooldowns.has(command.name)) {
        cooldowns.set(command.name, new Collection());
    }

    const now = Date.now();
    const timestamps = cooldowns.get(command.name);
    const cooldownAmount = (command.cooldown || 3) * 1000;


    if (timestamps.has(author.id)) {
        const expirationTime = timestamps.get(author.id) + cooldownAmount;

        if (now &lt; expirationTime) {
            const timeLeft = (expirationTime - now) / 1000;
            return message.reply(`please wait ${timeLeft.toFixed(1)} more second(s) before reusing the \`${command.name}\` command.`);
        }
    }

    timestamps.set(author.id, now);
    setTimeout(() => timestamps.delete(message.author.id), cooldownAmount);

    let argumentCommand, permission

    if (!isEmpty(args)) {
        !isEmpty(args[1]) ? argumentCommand = args[1] : argumentCommand = null

        const commandOptions = {gm: localGuild, args:argumentCommand, message: message, unite: this.unite, ready: guildReady}
        new Promise(function (resolve, reject) {
            resolve(unite.getAccess(message))
            reject('Доступ к данной функции Вам запрещен, обратитесь к администратору')

        }).then(
            access => {
                if (access) {



                    if(!isEmpty(args[0])){
                        devs.debug('Start with argument arg[1]', args[0])
                        command[args[0]](commandOptions)
                    } else {
                        devs.debug('Start with argument - args', args)
                        command.execute(message, unite, args, guild, guildReady);
                    }

                }
            }).catch(error => devs.error(error))

    }else {
        try {
            devs.debug('Start not argument', args)
            command.execute(message, unite, args, guild, guildReady);
        } catch (error) {
            devs.error(error);
            message.reply('there was an error trying to execute that command!');
        }
    }



}
</code></pre>
		</section>
			</div>
		</div>
	</div>
	<footer>
				<div class="footer-option">Redmine <a href='https://unitebot.fun'>https://unitebot.fun</a></div>
				<div class="copyright">Copyright by「CODΞ」DΞVS 2020</div>
			<div class="generated-by">Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Monday, October 12th 2020, 7:28:04 pm using the <a href="https://github.com/steveush/foodoc">FooDoc template</a>.</div>
	</footer>
	<script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/clipboard.min.js"></script>
	<script src="js/prism.min.js"></script>
	<script src="js/template.min.js"></script>
		<!-- start:lunr-search-modal.hbs -->
		<div class="modal fade" id="lunr-search-modal">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">Search results</h4>
					</div>
					<div class="modal-body" id="lunr-search-body">
					</div>
					<div class="modal-footer" id="lunr-search-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div>
		<!-- end:lunr-search-modal.hbs -->		<script src="js/lunr.min.js"></script>
	
</body>
</html>
<!-- end:source.tmpl.hbs -->